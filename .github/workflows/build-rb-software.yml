name: Build GAPS Time-of-Flight RB Software

on:
  push:
    branches:
      - main
      - takeru-dev
  pull_request:

env:
  RUST_TARGET: armv7-unknown-linux-musleabi
  CARGO_TARGET_ARMV7_UNKNOWN_LINUX_GNUEABI_RUSTFLAGS: -C relocation-model=dynamic-no-pic -C target-feature=+crt-static

jobs:
  build-armv7:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ env.RUST_TARGET }}

      - name: Show rustc version
        run: rustc -Vv

      - name: Install cross
        run: cargo install cross --locked

      - name: Build in src/bin/* with cross
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob

          bins=()
          for f in src/bin/*.rs; do
            bin_name="$(basename "$f" .rs)"
            bins+=("$bin_name")
          done

          if [ ${#bins[@]} -eq 0 ]; then
            echo "No src/bin/*.rs files found; nothing to build."
            exit 0
          fi

          echo "Found bin targets: ${bins[*]}"

          for bin in "${bins[@]}"; do
            echo "=== Building bin target: $bin ==="
            cross build --release --target "$RUST_TARGET" --bin "$bin"
            alt_bin="${bin//_/-}"
            echo "=== Building bin target: $alt_bin ==="
            cross build --release --target "$RUST_TARGET" --bin "$alt_bin"
            echo "Successfully built bin '$alt_bin'"
          done

      - name: Collect built binaries into artifacts directory
        shell: bash
        run: |
          OUTDIR="target/artifacts-armv7"
          mkdir -p "$OUTDIR"

          find "target/$RUST_TARGET/release" \
            -maxdepth 1 \
            -type f \
            -executable \
            -exec cp {} "$OUTDIR/" \;

          echo "Placed artifacts in: $OUTDIR"

      - name: Upload binary artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tof-control-${{ env.RUST_TARGET }}-binaries
          path: target/artifacts-armv7

    